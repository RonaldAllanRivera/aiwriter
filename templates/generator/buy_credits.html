{% extends "generator/base.html" %}
{% load static %}

{% block content %}
<div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow text-center">
  <h2 class="text-2xl font-bold mb-4">Buy {{ SITE_NAME }} Credits</h2>
  <p class="mb-6 text-gray-600">Select how many credits you want to buy. $1 = 1 credit.</p>

  <form id="checkout-form" method="post" class="space-y-4">
    {% csrf_token %}
    <select name="credits" class="w-full px-4 py-2 border rounded">
      <option value="10">10 Credits - $10</option>
      <option value="50">50 Credits - $50</option>
      <option value="100">100 Credits - $100</option>
    </select>
    <button type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
      Proceed to Payment
    </button>
  </form>

  <div id="error-message" class="text-red-500 mt-4 hidden"></div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_publishable_key }}");
  const form = document.getElementById("checkout-form");
  const errorDiv = document.getElementById("error-message");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    const formData = new FormData(form);

    const response = await fetch("{% url 'create_checkout_session' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      },
      body: formData,
    });

    const data = await response.json();

    if (data.id) {
      stripe.redirectToCheckout({ sessionId: data.id });
    } else {
      errorDiv.classList.remove("hidden");
      errorDiv.textContent = "Failed to start payment session. Please try again.";
    }
  });
</script>
{% endblock %}
